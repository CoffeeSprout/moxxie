name: PMD Code Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  pmd:
    name: PMD Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
          
    - name: Run PMD Analysis
      run: ./mvnw pmd:pmd
      
    - name: Generate PMD Report
      if: always()
      run: ./mvnw pmd:pmd -Dformat=xml
      
    - name: Upload PMD Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pmd-report
        path: target/pmd.xml
        
    - name: Publish PMD Results
      if: always()
      uses: pmd/pmd-github-action@v2
      with:
        rulesets: 'pmd-ruleset.xml'
        sourcePath: 'src/main/java'
        analyzeModifiedFilesOnly: false
        
    - name: Comment PR with PMD violations
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');
          const pmdReport = fs.readFileSync('target/pmd.xml', 'utf8');
          const violations = pmdReport.match(/<violation/g);
          const violationCount = violations ? violations.length : 0;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `⚠️ PMD found ${violationCount} code quality issues. Please review the PMD report in the workflow artifacts.`
          });